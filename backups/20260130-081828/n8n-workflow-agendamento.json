{
  "name": "Instituto Ariana Borges - Agendamento",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get_availability",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        600
      ],
      "id": "webhook-get-availability",
      "name": "Webhook - Verificar Disponibilidade",
      "webhookId": "get_availability"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "book_appointment",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        300
      ],
      "id": "webhook-book-appointment",
      "name": "Webhook - Agendar",
      "webhookId": "book_appointment"
    },
    {
      "parameters": {
        "jsCode": "const customerName = $input.item.json.customer_name;\nconst customerPhone = $input.item.json.customer_phone;\nconst customerEmail = $input.item.json.customer_email;\nconst serviceType = $input.item.json.service_type;\nconst description = $input.item.json.description;\nconst preferredTimeframe = $input.item.json.preferred_timeframe;\n\nreturn {\n  json: {\n    customerName,\n    customerPhone,\n    customerEmail,\n    serviceType,\n    description,\n    preferredTimeframe,\n    currentDate: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        300
      ],
      "id": "extract-booking-data",
      "name": "Extrair Dados do Booking"
    },
    {
      "parameters": {
        "jsCode": "const preferredTimeframe = $input.item.json.preferred_timeframe;\nconst currentDate = new Date().toISOString();\n\nreturn {\n  json: {\n    preferredTimeframe,\n    currentDate\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        600
      ],
      "id": "extract-availability-data",
      "name": "Extrair Dados de Disponibilidade"
    },
    {
      "parameters": {
        "text": "={{ $json.preferredTimeframe }}",
        "schemaType": "fromJson",
        "jsonSchemaExample": "{\n  \"startDateTime\": \"YYYY-MM-DDTHH:mm:00-03:00\",\n  \"endDateTime\": \"YYYY-MM-DDTHH:mm:00-03:00\",\n  \"interpretedDate\": \"descriÃ§Ã£o legÃ­vel\"\n}",
        "options": {
          "systemPromptTemplate": "VocÃª Ã© um assistente que converte texto em datas no formato ISO 8601.\n\nDATA ATUAL DE REFERÃŠNCIA: {{$json.currentDate}}\nTIMEZONE: America/Sao_Paulo (UTC-03:00)\n\nSua tarefa:\n1. Interpretar o texto de horÃ¡rio preferido\n2. Converter para formato ISO 8601 com timezone -03:00\n3. DuraÃ§Ã£o padrÃ£o: 1 hora\n4. HorÃ¡rio comercial: 9h Ã s 18h\n5. Se for \"manhÃ£\": 9h, \"tarde\": 14h, \"qualquer horÃ¡rio\": 14h\n\nFormato de resposta (JSON):\n- startDateTime: string ISO 8601 (exemplo: 2026-01-30T14:00:00-03:00)\n- endDateTime: string ISO 8601 (1 hora depois do start)\n- interpretedDate: string legÃ­vel (exemplo: TerÃ§a-feira, 30 de janeiro Ã s 14h)\n\nRetorne APENAS o JSON sem markdown."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        680,
        300
      ],
      "id": "ai-parse-date-booking",
      "name": "IA - Converter Texto para Data"
    },
    {
      "parameters": {
        "text": "={{ $json.preferredTimeframe }}",
        "schemaType": "fromJson",
        "jsonSchemaExample": "{\n  \"available\": true,\n  \"requestedDateTime\": \"YYYY-MM-DDTHH:mm:00-03:00\",\n  \"message\": \"mensagem amigÃ¡vel sobre disponibilidade\",\n  \"suggestedTimes\": [\"horÃ¡rio1\", \"horÃ¡rio2\", \"horÃ¡rio3\"]\n}",
        "options": {
          "systemPromptTemplate": "VocÃª Ã© um assistente que verifica disponibilidade de agenda.\n\nDATA ATUAL: {{$json.currentDate}}\nTIMEZONE: America/Sao_Paulo\nHORÃRIO COMERCIAL: 9h Ã s 18h (Segunda a Sexta)\n\nSua tarefa:\n1. Interpretar o horÃ¡rio solicitado\n2. Converter para data ISO 8601 com timezone -03:00\n3. Verificar se estÃ¡ dentro do horÃ¡rio comercial\n4. OBRIGATÃ“RIO: Sugerir SEMPRE pelo menos 3 horÃ¡rios alternativos disponÃ­veis\n\nFormato de resposta (JSON):\n- available: boolean (true ou false)\n- requestedDateTime: string ISO 8601 (exemplo: 2026-01-30T14:00:00-03:00)\n- message: string com mensagem amigÃ¡vel sobre a disponibilidade\n- suggestedTimes: array de strings - OBRIGATÃ“RIO incluir pelo menos 3 horÃ¡rios (exemplos: Segunda-feira Ã s 9h, TerÃ§a-feira Ã s 14h, Quarta-feira Ã s 10h)\n\nIMPORTANTE: O campo suggestedTimes NUNCA pode estar vazio. Sempre sugira horÃ¡rios prÃ³ximos ao solicitado.\n\nRetorne APENAS o JSON sem markdown."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        680,
        600
      ],
      "id": "ai-check-availability",
      "name": "IA - Verificar Disponibilidade"
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.item.json.output;\n\nlet parsedDate;\ntry {\n  // Check if aiResponse is already an object or a string\n  if (typeof aiResponse === 'object') {\n    parsedDate = aiResponse;\n  } else if (typeof aiResponse === 'string') {\n    const cleanJson = aiResponse.replace(/```json\\n?|```/g, '').trim();\n    parsedDate = JSON.parse(cleanJson);\n  } else {\n    throw new Error('Formato de resposta inesperado');\n  }\n} catch (error) {\n  throw new Error('Erro ao parsear resposta da IA: ' + error.message);\n}\n\nif (!parsedDate.startDateTime || !parsedDate.endDateTime) {\n  throw new Error('IA nÃ£o retornou datas vÃ¡lidas');\n}\n\nreturn {\n  json: {\n    customerName: $input.item.json.customerName,\n    customerPhone: $input.item.json.customerPhone,\n    customerEmail: $input.item.json.customerEmail,\n    serviceType: $input.item.json.serviceType,\n    description: $input.item.json.description,\n    startDateTime: parsedDate.startDateTime,\n    endDateTime: parsedDate.endDateTime,\n    interpretedDate: parsedDate.interpretedDate,\n    eventSummary: `${$input.item.json.serviceType} - ${$input.item.json.customerName}`,\n    eventDescription: `ðŸ“‹ Agendamento\\n\\nðŸ‘¤ Cliente: ${$input.item.json.customerName}\\nðŸ“§ Email: ${$input.item.json.customerEmail}\\nðŸ“± Telefone: ${$input.item.json.customerPhone}\\n\\nðŸŒŸ ServiÃ§o: ${$input.item.json.serviceType}\\nðŸ“ ${$input.item.json.description}`\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ],
      "id": "process-ai-response-booking",
      "name": "Processar Resposta da IA"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "primary",
          "mode": "list",
          "cachedResultName": "CalendÃ¡rio Principal"
        },
        "start": "={{$json.startDateTime}}",
        "end": "={{$json.endDateTime}}",
        "options": {
          "description": "={{$json.eventDescription}}",
          "summary": "={{$json.eventSummary}}",
          "attendees": [
            "={{$json.customerEmail}}"
          ],
          "sendUpdates": "all",
          "timeZone": "America/Sao_Paulo"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1120,
        300
      ],
      "id": "google-calendar-create",
      "name": "Google Calendar - Criar Evento",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "CONFIGURE_SUAS_CREDENCIAIS",
          "name": "Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "primary",
          "mode": "list",
          "cachedResultName": "CalendÃ¡rio Principal"
        },
        "options": {
          "timeZone": "America/Sao_Paulo"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        900,
        600
      ],
      "id": "google-calendar-list",
      "name": "Google Calendar - Listar Eventos",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "CONFIGURE_SUAS_CREDENCIAIS",
          "name": "Google Calendar"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json.output;\nconst preferredTimeframe = $input.all().find(item => item.json.preferredTimeframe)?.json.preferredTimeframe || '';\nlet availabilityCheck;\n\ntry {\n  // Check if aiResponse is already an object or a string\n  if (typeof aiResponse === 'object') {\n    availabilityCheck = aiResponse;\n  } else if (typeof aiResponse === 'string') {\n    const cleanJson = aiResponse.replace(/```json\\n?|```/g, '').trim();\n    availabilityCheck = JSON.parse(cleanJson);\n  } else {\n    throw new Error('Formato de resposta inesperado');\n  }\n} catch (error) {\n  availabilityCheck = {\n    available: true,\n    requestedDateTime: new Date().toISOString(),\n    message: \"Estamos verificando a disponibilidade.\",\n    suggestedTimes: []\n  };\n}\n\n// Formatar o horÃ¡rio solicitado de forma legÃ­vel\nlet requestedTimeFormatted = preferredTimeframe;\nif (availabilityCheck.requestedDateTime) {\n  try {\n    const dt = new Date(availabilityCheck.requestedDateTime);\n    const daysOfWeek = ['Domingo', 'Segunda-feira', 'TerÃ§a-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'SÃ¡bado'];\n    const day = daysOfWeek[dt.getDay()];\n    const date = dt.getDate();\n    const month = dt.getMonth() + 1;\n    const hour = dt.getHours();\n    requestedTimeFormatted = `${day}, ${date}/${month} Ã s ${hour}h`;\n  } catch (e) {\n    // Manter o formato original se falhar\n  }\n}\n\n// Gerar horÃ¡rios de fallback se IA nÃ£o retornou\nif (!availabilityCheck.suggestedTimes || availabilityCheck.suggestedTimes.length === 0) {\n  const now = new Date();\n  const tomorrow = new Date(now);\n  tomorrow.setDate(tomorrow.getDate() + 1);\n  \n  const dayAfter = new Date(now);\n  dayAfter.setDate(dayAfter.getDate() + 2);\n  \n  const daysOfWeek = ['Domingo', 'Segunda-feira', 'TerÃ§a-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'SÃ¡bado'];\n  \n  availabilityCheck.suggestedTimes = [\n    `${daysOfWeek[tomorrow.getDay()]}, ${tomorrow.getDate()}/${tomorrow.getMonth() + 1} Ã s 9h`,\n    `${daysOfWeek[tomorrow.getDay()]}, ${tomorrow.getDate()}/${tomorrow.getMonth() + 1} Ã s 14h`,\n    `${daysOfWeek[dayAfter.getDay()]}, ${dayAfter.getDate()}/${dayAfter.getMonth() + 1} Ã s 10h`\n  ];\n}\n\nconst calendarEvents = $input.all().filter(item => item.json.id).map(item => ({\n  start: item.json.start?.dateTime,\n  end: item.json.end?.dateTime,\n  summary: item.json.summary\n}));\n\nconst requestedDateTime = availabilityCheck.requestedDateTime;\nconst hasConflict = calendarEvents.some(event => {\n  if (!event.start || !requestedDateTime) return false;\n  return new Date(event.start).toISOString() === new Date(requestedDateTime).toISOString();\n});\n\nlet finalMessage;\nif (hasConflict) {\n  finalMessage = `ðŸ˜” Infelizmente ${requestedTimeFormatted} jÃ¡ estÃ¡ ocupado.`;\n  if (availabilityCheck.suggestedTimes?.length > 0) {\n    finalMessage += `\\n\\nHorÃ¡rios disponÃ­veis:\\n${availabilityCheck.suggestedTimes.map(t => `â€¢ ${t}`).join('\\n')}`;\n  }\n} else {\n  finalMessage = `âœ… âœ¨ Ã“tima notÃ­cia! ${requestedTimeFormatted} estÃ¡ disponÃ­vel!`;\n  if (availabilityCheck.suggestedTimes?.length > 0) {\n    finalMessage += `\\n\\nOutros horÃ¡rios disponÃ­veis:\\n${availabilityCheck.suggestedTimes.map(t => `â€¢ ${t}`).join('\\n')}`;\n  }\n}\n\nreturn {\n  json: {\n    available: !hasConflict,\n    message: finalMessage,\n    requestedDateTime: requestedDateTime,\n    suggestedTimes: availabilityCheck.suggestedTimes || []\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        600
      ],
      "id": "process-availability",
      "name": "Processar Disponibilidade"
    },
    {
      "parameters": {
        "respondWith": "json",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        },
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Tudo certo! VocÃª estÃ¡ agendado(a) para ' + $('Processar Resposta da IA').item.json.interpretedDate + '. ðŸŽ‰', booking: { customer: $('Processar Resposta da IA').item.json.customerName, service: $('Processar Resposta da IA').item.json.serviceType, dateTime: $('Processar Resposta da IA').item.json.interpretedDate, calendarEventId: $json.id } }) }}"
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.2,
      "position": [
        1340,
        300
      ],
      "id": "respond-success",
      "name": "Responder - Agendamento Confirmado"
    },
    {
      "parameters": {
        "respondWith": "json",
        "options": {
          "responseCode": 500,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        },
        "responseBody": "={{ JSON.stringify({ success: false, message: 'NÃ£o foi possÃ­vel completar o agendamento. Por favor, tente novamente ou entre em contato via WhatsApp.', error: $json.message || 'Erro desconhecido' }) }}"
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.2,
      "position": [
        1340,
        500
      ],
      "id": "respond-error",
      "name": "Responder - Erro"
    },
    {
      "parameters": {
        "respondWith": "json",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        },
        "responseBody": "={{ JSON.stringify({ available: $json.available, message: $json.message, suggestedTimes: $json.suggestedTimes }) }}"
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.2,
      "position": [
        1340,
        600
      ],
      "id": "respond-availability",
      "name": "Responder - Disponibilidade"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        680,
        480
      ],
      "id": "google-gemini-model",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googleGeminiApi": {
          "id": "CONFIGURE_SUAS_CREDENCIAIS",
          "name": "Google Gemini"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Verificar Disponibilidade": {
      "main": [
        [
          {
            "node": "Extrair Dados de Disponibilidade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - Agendar": {
      "main": [
        [
          {
            "node": "Extrair Dados do Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados do Booking": {
      "main": [
        [
          {
            "node": "IA - Converter Texto para Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados de Disponibilidade": {
      "main": [
        [
          {
            "node": "IA - Verificar Disponibilidade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA - Converter Texto para Data": {
      "main": [
        [
          {
            "node": "Processar Resposta da IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA - Verificar Disponibilidade": {
      "main": [
        [
          {
            "node": "Google Calendar - Listar Eventos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Resposta da IA": {
      "main": [
        [
          {
            "node": "Google Calendar - Criar Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Calendar - Criar Evento": {
      "main": [
        [
          {
            "node": "Responder - Agendamento Confirmado",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Responder - Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Calendar - Listar Eventos": {
      "main": [
        [
          {
            "node": "Processar Disponibilidade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Disponibilidade": {
      "main": [
        [
          {
            "node": "Responder - Disponibilidade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "IA - Converter Texto para Data",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "IA - Verificar Disponibilidade",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}